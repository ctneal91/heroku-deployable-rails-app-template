#!/usr/bin/env sh

# Source nvm if available (for CI environments that need it)
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

npx lint-staged

# Check if any Ruby files were changed
if git diff --cached --name-only | grep -qE '\.rb$'; then
  echo "Running Rails test coverage check..."
  bundle exec rspec --format progress
  if [ $? -ne 0 ]; then
    echo "Rails tests failed or coverage is below threshold"
    exit 1
  fi
fi

# Check if any frontend files were changed
if git diff --cached --name-only | grep -qE '^frontend/src/.*\.(ts|tsx)$'; then
  echo "Running React test coverage check..."
  cd frontend && npm test -- --coverage --watchAll=false
  if [ $? -ne 0 ]; then
    echo "React tests failed or coverage is below threshold"
    exit 1
  fi
fi
